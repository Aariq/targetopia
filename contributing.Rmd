---
title: "Contributing"
output: distill::distill_article
description: "How to create a targetopia package"
---

```{r, include = FALSE}
knitr::opts_chunk$set(eval = FALSE, echo = TRUE)
```

The targetopia aims to cover many fields of Statistics and data science, and community contributions help enormously. The following best practices assist R developers in creating their own targetopia packages.

## Before you begin

### Prerequisites

1. Domain knowledge: Bayesian statistics, deep neural networks, or whatever methodology the package will develop workflows for.
1. Expertise with [`targets`](https://wlandau.github.io/targets). The [documentation website](https://wlandau.github.io/targets) links to helpful resources, including the [user manual](https://wlandau.github.io/targets-manual), [example projects](https://wlandau.github.io/targets/#examples), and [recorded talks](https://wlandau.github.io/targets/#recorded-talks). And direct experience with [`targets`](https://wlandau.github.io/targets) in a real-world project goes a long way.
1. [R package development](https://r-pkgs.org/), including [documentation](https://r-pkgs.org/man.html) and [testing](https://r-pkgs.org/tests.html).

### Scope

In the backend, each targetopia package should dedicate itself to an existing implementation of an underlying methodology. For example, [`stantargets`](https://wlandau.github.io/stantargets) caters to [`cmdstanr`](https://mc-stan.org/cmdstanr/), and [`jagstargets`]() is caters to [`R2jags`](https://github.com/suyusung/R2jags). Do not be afraid to overfit to the methodology package.^[But please only use exported functions (`::`, not `:::`).] For example, [`stantargets`](https://wlandau.github.io/stantargets) chooses an interface that works extremely well with [`cmdstanr`](https://mc-stan.org/cmdstanr/) but poorly with [`brms`](https://paul-buerkner.github.io/brms/), and that is totally appropriate. As [discussed here](https://github.com/wlandau/stantargets/issues/12), the targetopia needs a completely different package to accommodate [`brms`](https://paul-buerkner.github.io/brms/) workflows.

## Implementation

### Target factories

Target factories are the heart of every targetopia package. A target factory is a function that calls [`tar_target_raw()`](https://wlandau.github.io/targets/reference/tar_target_raw.html) to produces a list of targets. Users supply minimal easy-to-understand inputs, and the factory constructs a sophisticated pipeline tailored to the scenario at hand.

```{r}
# R/factory.R
#' @export
#' @param data Character, data file path.
target_factory <- function(data) {
  list(
    tar_target_raw("file", data, format = "file", deployment = "main"),
    tar_target_raw("simple_model", quote(run_simple(file)), format = "fst_tbl")
  )
}
```

In `_targets.R`, the user writes one call to the factory instead of multiple calls to `tar_target()`. This shorthand simplifies pipeline construction by reducing the volume of code required and abstracting away settings like `format = "file"` and `deployment = "main"`.

```{r}
# _targets.R
library(targets)
library(yourExamplePackage)
tar_pipeline(target_factory("dataset.csv"))
```

```{r}
# R console
tar_manifest(fields = command)
#> # A tibble: 2 x 2
#>   name         command
#>   <chr>        <chr>
#> 1 simple_model "run_simple(file)"
#> 2 file         "\"dataset.csv\""
```

Sometimes, these factories require metaprogramming. Functions [`substitute()`](http://adv-r.had.co.nz/Computing-on-the-language.html#substitute), [`tar_sub()`](https://wlandau.github.io/tarchetypes/reference/tar_sub.html), and [`tar_eval()`](https://wlandau.github.io/tarchetypes/reference/tar_eval.html) can help create [language objects](http://adv-r.had.co.nz/Computing-on-the-language.html#capturing-expressions) for the `command` argument of [`tar_target_raw()`](https://wlandau.github.io/targets/reference/tar_target_raw.html). This is useful, for example, if you want to users to a base name for the targets.

```{r}
# R/factory.R
#' @export
#' @param name Symbol, name for the collection of targets.
#' @param data Character, data file path.
target_factory <- function(name, data) {
  name_text <- deparse(substitute(name))
  name_file <- paste0(name_text, "_file")
  sym_file <- as.symbol(name_file)
  command <- substitute(run_simple(file), env = list(file = sym_file))
  list(
    tar_target_raw(name_file, data, format = "file", deployment = "main"),
    tar_target_raw(name_text, command, format = "fst_tbl")
  )
}
```

```{r}
# R console
tar_manifest(fields = command)
#> # A tibble: 2 x 2
#>   name        command                  
#>   <chr>       <chr>                    
#> 1 custom      "run_simple(custom_file)"
#> 2 custom_file "\"dataset.csv\"" 
```

### Settings

Target factories should automatically supply optimal arguments to [`tar_target_raw()`](https://wlandau.github.io/targets/reference/tar_target_raw.html) wherever possible. The above `target_factory()` demonstrates three such examples:

* `format = "file"`: as developers, we know we need a target to track changes to the the input data file.



### Branching

## Examples

### Runtime

### Cleanup

## Testing

### Manifest

### Network

### Results

### Cleanup



I do plan to write a more lengthy guide to contributing such packages, but for now, Functions [`tar_manifest()`](https://wlandau.github.io/targets/reference/tar_manifest.html), [`tar_network()`](https://wlandau.github.io/targets/reference/tar_network.html), [`tar_dir()`](https://wlandau.github.io/targets/reference/tar_dir.html), and [`tar_test()`](https://wlandau.github.io/targets/reference/tar_test.html) help write [examples](https://r-pkgs.org/man.html?q=examples#man-workflow) and [tests](https://testthat.r-lib.org/).


## Examples

Feel free to borrow the source code of [`stantargets`](https://github.com/wlandau/stantargets) and [`tarchetypes`](https://github.com/wlandau/tarchetypes).

## Contact

please do not hesitate to reach out.

<ul>
<li>`r fontawesome::fa("github")` [`@wlandau`](https://github.com/wlandau)</li>
<li>`r fontawesome::fa("linkedin")` [`@wlandau`](https://linkedin.com/in/wlandau)</li>
<li>`r fontawesome::fa("twitter")` [`@wmlandau`](https://twitter.com/wmlandau)</li>
</ul>